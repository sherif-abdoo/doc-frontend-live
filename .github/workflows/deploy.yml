name: Deploy Frontend

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy over SSH (build on server)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            bash -lc '
              set -euo pipefail
              set -x

              export NVM_DIR="$HOME/.nvm"
              . "$NVM_DIR/nvm.sh" --no-use
              nvm use 20 >/dev/null 2>&1 || nvm install 20
              node -v
              npm -v

              cd "${{ secrets.FRONTEND_PATH }}"

              git fetch --all
              git reset --hard origin/main

              # --- Debug: show env files and any ${VAR} expansions (loops risk) ---
              ls -la .env* || true
              grep -nR "\${" .env* || true

              # --- Create/overwrite production env file ---
              cat > .env.production << "EOF"
              REACT_APP_API_BASE=
              REACT_APP_ADMIN_PASSKEY=DOCADMIN
              REACT_APP_PRESIGN_URL=https://r2-presign.dok-uploads.workers.dev
              REACT_APP_R2_READER_BASE=https://r2-read.dok-uploads.workers.dev
              EOF

              if [ -f package-lock.json ]; then
                npm ci
              else
                npm install
              fi

              # --- Build with a clean environment to avoid dotenv-expand recursion from exported vars ---
              env -i \
                HOME="$HOME" \
                PATH="$PATH" \
                NVM_DIR="$NVM_DIR" \
                NODE_ENV=production \
                bash -lc ". \"$NVM_DIR/nvm.sh\" --no-use && nvm use 20 >/dev/null && npm run build"

              test -d build || (echo "ERROR: build/ not found in $(pwd)" && exit 3)
              test -d "${{ secrets.NGINX_WEB_ROOT }}" || (echo "ERROR: NGINX_WEB_ROOT not found: ${{ secrets.NGINX_WEB_ROOT }}" && exit 3)

              sudo -n true || (echo "ERROR: sudo requires password (non-interactive). Fix sudoers." && exit 3)

              sudo rsync -a --delete build/ "${{ secrets.NGINX_WEB_ROOT }}/"
              sudo nginx -t
              sudo systemctl reload nginx
            '
